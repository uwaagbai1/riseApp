{% extends 'account/base_generic.html' %}
{% load static %}

{% block content %}
<div class="hp-main-layout-content">
    <div class="row mb-32 gy-32">
        <!-- Header -->
        <div class="col-12">
            <div class="hp-bg-black-bg py-32 py-sm-64 px-24 px-sm-48 px-md-80 position-relative overflow-hidden hp-page-content" style="border-radius: 32px;">
                <svg width="358" height="336" fill="none" xmlns="http://www.w3.org/2000/svg" class="position-absolute hp-rtl-scale-x-n1" style="bottom: 0px; right: 0px;">
                    <path d="M730.404 135.471 369.675-6.641l88.802 164.001-243.179-98.8 246.364 263.281-329.128-126.619 114.698 166.726-241.68-62.446" stroke="url(#a)" stroke-width="40" stroke-linejoin="bevel"></path>
                    <defs>
                        <linearGradient id="a" x1="315.467" y1="6.875" x2="397.957" y2="337.724" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#fff"></stop>
                            <stop offset="1" stop-color="#fff" stop-opacity="0"></stop>
                        </linearGradient>
                    </defs>
                </svg>
                <div class="row">
                    <div class="col-sm-8 col-12">
                        <div class="row">
                            <div class="col-12">
                                <h1 class="mb-0 hp-text-color-black-0">Subject Management</h1>
                                <h4 class="mt-8 hp-text-color-black-0">Manage subjects across classes and sections</h4>
                                <button type="button" class="btn btn-transparent mt-2" data-bs-toggle="modal" data-bs-target="#addSubjectModal">Add New Subject</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="col-12">
            <div class="card hp-bg-color-dark-90 p-24">
                <form id="filterForm" class="row g-16 align-items-end mb-24">
                    <div class="col-md-4 col-sm-6">
                        <label for="classFilter" class="form-label ">Class</label>
                        <select id="classFilter" class="form-select bg-dark  border-dark" style="border-radius: 8px;">
                            <option value="">All Classes</option>
                            {% for class in classes %}
                            <option value="{{ class.id }}">{{ class.level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <label for="sectionFilter" class="form-label ">Section</label>
                        <select id="sectionFilter" class="form-select bg-dark  border-dark" style="border-radius: 8px;">
                            <option value="">All Sections</option>
                            <option value="Nursery">Nursery</option>
                            <option value="Primary">Primary</option>
                            <option value="Junior">Junior</option>
                            <option value="Senior">Senior</option>
                        </select>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <label for="subjectFilter" class="form-label ">Subject Name</label>
                        <input type="text" id="subjectFilter" class="form-control bg-dark  border-dark" placeholder="Search subjects..." style="border-radius: 8px;">
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table">
                        <thead class="table">
                            <tr>
                                <th style="border: 1px solid #444;">Name</th>
                                <th style="border: 1px solid #444;">Class</th>
                                <th style="border: 1px solid #444;">Section</th>
                                <th style="border: 1px solid #444;">Compulsory</th>
                                <th style="border: 1px solid #444;">Status</th>
                                <th style="border: 1px solid #444;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjectsTableBody">
                            {% for subject in subjects %}
                            <tr data-subject-id="{{ subject.id }}">
                                <td style="border: 1px solid #444;">{{ subject.name }}</td>
                                <td style="border: 1px solid #444;">
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for class in subject.school_class.all %}
                                        <span class="badge level bg-dark px-2 py-1" style="border-radius: 12px;">{{ class.level }}</span>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td style="border: 1px solid #444;">{{ subject.section }}</td>
                                <td style="border: 1px solid #444;">
                                    <span class="badge {% if subject.compulsory %}bg-success{% else %}bg-warning{% endif %} px-2 py-1" style="border-radius: 12px;">
                                        {{ subject.compulsory|yesno:"Compulsory,Optional" }}
                                    </span>
                                </td>
                                <td style="border: 1px solid #444;">
                                    <span class="badge {% if subject.is_active %}bg-success{% else %}bg-danger{% endif %} px-2 py-1" style="border-radius: 12px;">
                                        {{ subject.is_active|yesno:"Active,Inactive" }}
                                    </span>
                                </td>
                                <td style="border: 1px solid #444;">
                                    <button class="btn btn-sm btn-dark me-2 edit-subject" data-bs-toggle="modal" data-bs-target="#editSubjectModal" data-subject-id="{{ subject.id }}">Edit</button>
                                    <button class="btn btn-sm btn-danger toggle-status" data-subject-id="{{ subject.id }}">{{ subject.is_active|yesno:"Deactivate,Activate" }}</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center" style="border: 1px solid #444;">No subjects found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Subject Modal -->
<div class="modal fade" id="addSubjectModal" tabindex="-1" aria-labelledby="addSubjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content hp-bg-color-dark-90">
            <div class="modal-header">
                <h5 class="modal-title " id="addSubjectModalLabel">Add New Subject</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSubjectForm">
                    {% csrf_token %}
                    <fieldset>
                        <legend class="">Subject Details</legend>
                        <div class="mb-3">
                            <label for="addSubjectName" class="form-label ">Subject Name</label>
                            <input type="text" class="form-control bg-dark  border-dark" id="addSubjectName" name="name" required placeholder="Enter subject name" style="border-radius: 8px;">
                        </div>
                        <div class="mb-3">
                            <label for="addSubjectSection" class="form-label ">Section</label>
                            <select class="form-select bg-dark  border-dark" id="addSubjectSection" name="section" required style="border-radius: 8px;">
                                <option value="">Select Section</option>
                                <option value="Nursery">Nursery</option>
                                <option value="Primary">Primary</option>
                                <option value="Junior">Junior</option>
                                <option value="Senior">Senior</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="addSubjectClasses" class="form-label ">Classes</label>
                            <select multiple class="form-select bg-dark  border-dark" id="addSubjectClasses" name="classes" required style="border-radius: 8px;">
                                {% for class in classes %}
                                <option value="{{ class.id }}">{{ class.level }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="addSubjectCompulsory" name="compulsory">
                                <label class="form-check-label " for="addSubjectCompulsory">Compulsory</label>
                            </div>
                        </div>
                    </fieldset>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-dark">Add Subject</button>
                        <button type="button" class="btn btn-transparent" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subject Modal -->
<div class="modal fade" id="editSubjectModal" tabindex="-1" aria-labelledby="editSubjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content hp-bg-color-dark-90">
            <div class="modal-header">
                <h5 class="modal-title " id="editSubjectModalLabel">Edit Subject</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSubjectForm">
                    {% csrf_token %}
                    <input type="hidden" id="editSubjectId" name="subject_id">
                    <fieldset>
                        <legend class="">Subject Details</legend>
                        <div class="mb-3">
                            <label for="editSubjectName" class="form-label ">Subject Name</label>
                            <input type="text" class="form-control bg-dark  border-dark" id="editSubjectName" name="name" required placeholder="Enter subject name" style="border-radius: 8px;">
                        </div>
                        <div class="mb-3">
                            <label for="editSubjectSection" class="form-label ">Section</label>
                            <select class="form-select bg-dark  border-dark" id="editSubjectSection" name="section" required style="border-radius: 8px;">
                                <option value="Nursery">Nursery</option>
                                <option value="Primary">Primary</option>
                                <option value="Junior">Junior</option>
                                <option value="Senior">Senior</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editSubjectClasses" class="form-label ">Classes</label>
                            <select multiple class="form-select bg-dark  border-dark" id="editSubjectClasses" name="classes" required style="border-radius: 8px;">
                                {% for class in classes %}
                                <option value="{{ class.id }}">{{ class.level }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editSubjectCompulsory" name="compulsory">
                                <label class="form-check-label " for="editSubjectCompulsory">Compulsory</label>
                            </div>
                        </div>
                    </fieldset>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-dark">Save Changes</button>
                        <button type="button" class="btn btn-transparent" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.form-label {
    font-weight: bold;
    margin-bottom: 0.5rem;
}
.form-select, .form-control {
    background-color: #2d2d2d !important;
    border-color: #444 !important;
    color: #fff !important;
    border-radius: 8px !important;
    transition: all 0.3s ease;
}
.form-select:focus, .form-control:focus {
    border-color: #666 !important;
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.2) !important;
}
.form-check-input {
    background-color: #444;
    border-color: #666;
    cursor: pointer;
}
.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
}
.form-check-input:focus {
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
}
.table th, .table td {
    padding: 12px;
    vertical-align: middle;
    border: 1px solid #444;
}
.table-hover tbody tr:hover {
    background-color: #2a2e34;
}
.badge {
    font-size: 0.85rem;
    margin-right: 4px;
    margin-bottom: 4px;
}


</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    const csrftoken = $('[name=csrfmiddlewaretoken]').val();

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Update subjects table
    function updateSubjectsTable() {
        const classFilter = $('#classFilter').val();
        const sectionFilter = $('#sectionFilter').val();
        const subjectFilter = $('#subjectFilter').val();

        $.ajax({
            url: '{% url "filter_subjects" %}',
            type: 'GET',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                class_id: classFilter,
                section: sectionFilter,
                name: subjectFilter
            },
            success: function(data) {
                let html = '';
                if (data.subjects && data.subjects.length > 0) {
                    data.subjects.forEach(subject => {
                        html += `
                            <tr data-subject-id="${subject.id}">
                                <td style="border: 1px solid #444;">${subject.name}</td>
                                <td style="border: 1px solid #444;">
                                    <div class="d-flex flex-wrap gap-1">
                                        ${subject.classes.map(c => `<span class="badge bg-dark  px-2 py-1" style="border-radius: 12px;">${c}</span>`).join('')}
                                    </div>
                                </td>
                                <td style="border: 1px solid #444;">${subject.section}</td>
                                <td style="border: 1px solid #444;">
                                    <span class="badge ${subject.compulsory ? 'bg-success' : 'bg-warning'} px-2 py-1" style="border-radius: 12px;">
                                        ${subject.compulsory ? 'Compulsory' : 'Optional'}
                                    </span>
                                </td>
                                <td style="border: 1px solid #444;">
                                    <span class="badge ${subject.is_active ? 'bg-success' : 'bg-danger'} px-2 py-1" style="border-radius: 12px;">
                                        ${subject.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td style="border: 1px solid #444;">
                                    <button class="btn btn-sm btn-dark me-2 edit-subject" data-bs-toggle="modal" data-bs-target="#editSubjectModal" data-subject-id="${subject.id}">Edit</button>
                                    <button class="btn btn-sm btn-danger toggle-status" data-subject-id="${subject.id}">${subject.is_active ? 'Deactivate' : 'Activate'}</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    html = '<tr><td colspan="6" class="text-center" style="border: 1px solid #444;">No subjects found</td></tr>';
                }
                $('#subjectsTableBody').html(html);
            },
            error: function(xhr) {
                alert('Error loading subjects: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    }

    // Filter event listeners
    const debouncedUpdate = debounce(updateSubjectsTable, 500);
    $('#classFilter, #sectionFilter').on('change', debouncedUpdate);
    $('#subjectFilter').on('keyup', debouncedUpdate);

    // Add subject form submission
    $('#addSubjectForm').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const classes = $('#addSubjectClasses').val() || [];
        formData.set('classes', classes.join(','));

        $.ajax({
            url: '{% url "admin_manage_subjects" %}',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#addSubjectModal').modal('hide');
                    $('#addSubjectForm')[0].reset();
                    updateSubjectsTable();
                    alert(response.message);
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('Error adding subject: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    });

    // Edit subject button click
    $(document).on('click', '.edit-subject', function() {
        const subjectId = $(this).data('subject-id');
        $.ajax({
            url: '{% url "get_subject" %}',
            type: 'GET',
            headers: { 'X-CSRFToken': csrftoken },
            data: { subject_id: subjectId },
            success: function(data) {
                $('#editSubjectId').val(data.id);
                $('#editSubjectName').val(data.name);
                $('#editSubjectSection').val(data.section);
                $('#editSubjectCompulsory').prop('checked', !!data.compulsory); // Ensure boolean conversion
                $('#editSubjectClasses').val(data.classes);
            },
            error: function(xhr) {
                alert('Error loading subject: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    });

    // Edit subject form submission
    $('#editSubjectForm').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const classes = $('#editSubjectClasses').val() || [];
        formData.set('classes', classes.join(','));
        formData.append('action', 'edit');

        $.ajax({
            url: '{% url "admin_manage_subjects" %}',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#editSubjectModal').modal('hide');
                    updateSubjectsTable();
                    alert(response.message);
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('Error updating subject: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    });

    // Toggle subject status
    $(document).on('click', '.toggle-status', function() {
        const subjectId = $(this).data('subject-id');
        $.ajax({
            url: '{% url "admin_manage_subjects" %}',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                subject_id: subjectId,
                action: 'toggle_status',
                csrfmiddlewaretoken: csrftoken
            },
            success: function(response) {
                if (response.success) {
                    updateSubjectsTable();
                    alert(response.message);
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('Error toggling status: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    });

    // Initialize table
    updateSubjectsTable();

    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();

    // Show toast messages if any
    $('.toast').each(function() {
        var toast = new bootstrap.Toast(this);
        toast.show();
    });
});
</script>
{% endblock %}