{% extends 'account/base_generic.html' %}
{% load static %}
{% block content %}
<div class="hp-main-layout-content">
    <div class="row mb-32 gy-32">
        <div class="col-12">
            <div class="hp-bg-black-bg py-32 py-sm-64 px-24 px-sm-48 px-md-80 position-relative overflow-hidden hp-page-content" style="border-radius: 32px;">
                <svg width="358" height="336" fill="none" xmlns="http://www.w3.org/2000/svg" class="position-absolute hp-rtl-scale-x-n1" style="bottom: 0px; right: 0px;">
                    <path d="M730.404 135.471 369.675-6.641l88.802 164.001-243.179-98.8 246.364 263.281-329.128-126.619 114.698 166.726-241.68-62.446" stroke="url(#a)" stroke-width="40" stroke-linejoin="bevel"></path>
                    <defs>
                        <linearGradient id="a" x1="315.467" y1="6.875" x2="397.957" y2="337.724" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#fff"></stop>
                            <stop offset="1" stop-color="#fff" stop-opacity="0"></stop>
                        </linearGradient>
                    </defs>
                </svg>
                <div class="row">
                    <div class="col-12">
                        <h1 class="mb-0 hp-text-color-black-0">Manage Result Access Requests</h1>
                        <h4 class="mt-8 hp-text-color-black-0">Review and handle student requests for result access</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card hp-bg-color-dark-90 p-24">
                <div class="mb-16">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="class_filter" class="form-label">Filter by Class</label>
                            <select name="class_filter" id="class_filter" class="form-select">
                                <option value="">All Classes</option>
                                {% for class in classes %}
                                    <option value="{{ class }}">{{ class }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="name_filter" class="form-label">Filter by Name</label>
                            <input type="text" name="name_filter" id="name_filter" class="form-control" placeholder="Enter student name">
                        </div>
                        <div class="col-md-2">
                            <label for="status_filter" class="form-label">Filter by Status</label>
                            <select name="status_filter" id="status_filter" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Denied">Denied</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="session_filter" class="form-label">Filter by Session</label>
                            <select name="session_filter" id="session_filter" class="form-select">
                                <option value="">All Sessions</option>
                                {% for session in sessions %}
                                    <option value="{{ session.id }}" {% if session == current_session %}selected{% endif %}>{{ session.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="term_filter" class="form-label">Filter by Term</label>
                            <select name="term_filter" id="term_filter" class="form-select">
                                <option value="">All Terms</option>
                                {% for term in terms %}
                                    <option value="{{ term.0 }}" {% if term.0 == selected_term %}selected{% endif %}>{{ term.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table" id="requests-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Session</th>
                                <th>Term</th>
                                <th>Status</th>
                                <th>Requested At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in requests %}
                            <tr>
                                <td>{{ request.student.full_name }}</td>
                                <td>{{ request.student.current_class.level|default:'N/A' }}</td>
                                <td>{{ request.session.name }}</td>
                                <td>{{ request.get_term_display }}</td>
                                <td>
                                    <span class="badge {% if request.status == 'Approved' %}bg-success{% elif request.status == 'Denied' %}bg-danger{% else %}bg-warning{% endif %}">
                                        {{ request.status }}
                                    </span>
                                </td>
                                <td>{{ request.requested_at|date:"F d, Y H:i" }}</td>
                                <td>
                                    {% if request.status == 'Pending' %}
                                        <button class="btn btn-sm btn-success grant-access-btn" data-request-id="{{ request.id }}">Grant</button>
                                        <button class="btn btn-sm btn-danger revoke-access-btn" data-request-id="{{ request.id }}">Deny</button>
                                    {% elif request.status == 'Approved' %}
                                        <button class="btn btn-sm btn-danger revoke-access-btn" data-request-id="{{ request.id }}">Revoke</button>
                                    {% elif request.status == 'Denied' %}
                                        <button class="btn btn-sm btn-success grant-access-btn" data-request-id="{{ request.id }}">Grant</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No result access requests found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .badge {
        font-size: 1.0em;
        color: black;
    }
    .table th, .table td {
        vertical-align: middle;
    }
    .filter-loading::after {
        content: '';
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .error-alert {
        display: none;
        margin-bottom: 1rem;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {

    $('.card').prepend('<div class="alert alert-danger error-alert" role="alert"></div>');

    function showError(message) {
        $('.error-alert').text(message).show();
        setTimeout(() => $('.error-alert').hide(), 5000);
    }

    function fetchRequests() {
        const filters = {
            class_filter: $('#class_filter').val(),
            name_filter: $('#name_filter').val(),
            status_filter: $('#status_filter').val(),
            session_filter: $('#session_filter').val(),
            term_filter: $('#term_filter').val()
        };

        $('#requests-table').addClass('filter-loading');
        $.ajax({
            url: '{% url "admin_manage_result_access_requests" %}',
            type: 'GET',
            data: filters,
            dataType: 'json',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('Fetch response:', response);
                $('.error-alert').hide();
                const tbody = $('#requests-table tbody');
                tbody.empty();
                if (response.requests && Array.isArray(response.requests) && response.requests.length > 0) {
                    response.requests.forEach(function(request) {
                        const statusBadgeClass = request.status === 'Approved' ? 'bg-success' :
                                                request.status === 'Denied' ? 'bg-danger' : 'bg-warning';
                        let actionButtons = '';
                        if (request.status === 'Pending') {
                            actionButtons = `
                                <button class="btn btn-sm btn-success grant-access-btn" data-request-id="${request.id}">Grant</button>
                                <button class="btn btn-sm btn-danger revoke-access-btn" data-request-id="${request.id}">Deny</button>
                            `;
                        } else if (request.status === 'Approved') {
                            actionButtons = `<button class="btn btn-sm btn-danger revoke-access-btn" data-request-id="${request.id}">Revoke</button>`;
                        } else if (request.status === 'Denied') {
                            actionButtons = `<button class="btn btn-sm btn-success grant-access-btn" data-request-id="${request.id}">Grant</button>`;
                        }
                        tbody.append(`
                            <tr>
                                <td>${request.student_full_name || 'N/A'}</td>
                                <td>${request.class_level || 'N/A'}</td>
                                <td>${request.session_name || 'N/A'}</td>
                                <td>${request.term_display || 'N/A'}</td>
                                <td><span class="badge ${statusBadgeClass}">${request.status}</span></td>
                                <td>${request.requested_at || 'N/A'}</td>
                                <td>${actionButtons}</td>
                            </tr>
                        `);
                    });
                } else {
                    tbody.append('<tr><td colspan="7" class="text-center">No result access requests found.</td></tr>');
                }
                $('#requests-table').removeClass('filter-loading');
            },
            error: function(xhr, status, error) {
                $('#requests-table').removeClass('filter-loading');
                console.error('Fetch error:', {
                    status: xhr.status,
                    responseText: xhr.responseText,
                    responseJSON: xhr.responseJSON
                });
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to fetch requests';
                showError(`Error fetching requests: ${errorMsg}`);
            }
        });
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    $('#class_filter, #status_filter, #session_filter, #term_filter').on('change', fetchRequests);
    $('#name_filter').on('input', debounce(fetchRequests, 300));

     fetchRequests();

    $('#requests-table').on('click', '.grant-access-btn, .revoke-access-btn', function() {
        const button = $(this);
        const requestId = button.data('request-id');
        const action = button.hasClass('grant-access-btn') ? 'grant' : 'revoke';

        button.prop('disabled', true).addClass('filter-loading');
        $.ajax({
            url: '{% url "admin_handle_result_access_request" %}',
            type: 'POST',
            data: {
                request_id: requestId,
                action: action,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Action response:', response);
                button.prop('disabled', false).removeClass('filter-loading');
                $('.error-alert').hide();
                if (response.success) {
                    const row = button.closest('tr');
                    const statusCell = row.find('td:nth-child(5)');
                    const actionCell = row.find('td:nth-child(7)');

                    statusCell.html(`<span class="badge ${response.status === 'Approved' ? 'bg-success' : 'bg-danger'}">${response.status}</span>`);

                    if (response.status === 'Approved') {
                        actionCell.html(`<button class="btn btn-sm btn-danger revoke-access-btn" data-request-id="${requestId}">Revoke</button>`);
                    } else {
                        actionCell.html(`<button class="btn btn-sm btn-success grant-access-btn" data-request-id="${requestId}">Grant</button>`);
                    }
                } else {
                    showError(`Error: ${response.error || 'Unknown error'}`);
                }
            },
            error: function(xhr, status, error) {
                button.prop('disabled', false).removeClass('filter-loading');
                console.error('Action error:', {
                    status: xhr.status,
                    responseText: xhr.responseText,
                    responseJSON: xhr.responseJSON
                });
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to perform action';
                showError(`Error performing action: ${errorMsg}`);
            }
        });
    });
});
</script>
{% endblock %}