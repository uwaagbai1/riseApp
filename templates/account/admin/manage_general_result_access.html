{% extends 'account/base_generic.html' %}
{% load static %}
{% block content %}
<div class="hp-main-layout-content">
    <div class="row mb-32 gy-32">
        <div class="col-12">
            <div class="hp-bg-black-bg py-32 py-sm-64 px-24 px-sm-48 px-md-80 position-relative overflow-hidden hp-page-content" style="border-radius: 32px;">
                <svg width="358" height="336" fill="none" xmlns="http://www.w3.org/2000/svg" class="position-absolute hp-rtl-scale-x-n1" style="bottom: 0px; right: 0px;">
                    <path d="M730.404 135.471 369.675-6.641l88.802 164.001-243.179-98.8 246.364 263.281-329.128-126.619 114.698 166.726-241.68-62.446" stroke="url(#a)" stroke-width="40" stroke-linejoin="bevel"></path>
                    <defs>
                        <linearGradient id="a" x1="315.467" y1="6.875" x2="397.957" y2="337.724" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#fff"></stop>
                            <stop offset="1" stop-color="#fff" stop-opacity="0"></stop>
                        </linearGradient>
                    </defs>
                </svg>
                <div class="row">
                    <div class="col-12">
                        <h1 class="mb-0 hp-text-color-black-0">Manage General Result Access</h1>
                        <h4 class="mt-8 hp-text-color-black-0">Grant result access to students without requests</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card hp-bg-color-dark-90 p-24">
                <div class="mb-16">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="class_filter" class="form-label">Filter by Class</label>
                            <select name="class_filter" id="class_filter" class="form-select">
                                <option value="">All Classes</option>
                                {% for class in classes %}
                                    <option value="{{ class }}">{{ class }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="name_filter" class="form-label">Filter by Name</label>
                            <input type="text" name="name_filter" id="name_filter" class="form-control" placeholder="Enter student name">
                        </div>
                        <div class="col-md-2">
                            <label for="session_filter" class="form-label">Filter by Session</label>
                            <select name="session_filter" id="session_filter" class="form-select">
                                <option value="">All Sessions</option>
                                {% for session in sessions %}
                                    <option value="{{ session.id }}" {% if session == current_session %}selected{% endif %}>{{ session.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="term_filter" class="form-label">Filter by Term</label>
                            <select name="term_filter" id="term_filter" class="form-select">
                                <option value="">All Terms</option>
                                {% for term in terms %}
                                    <option value="{{ term.0 }}" {% if term.0 == selected_term %}selected{% endif %}>{{ term.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="unpaid_fees" class="form-label">Filter by Fee Status</label>
                            <select name="unpaid_fees" id="unpaid_fees" class="form-select">
                                <option value="">All</option>
                                <option value="true">Unpaid</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-16">
                    <button class="btn btn-sm btn-secondary" id="select-all">Select All</button>
                    <button class="btn btn-sm btn-secondary" id="unselect-all">Unselect All</button>
                    <button class="btn btn-sm btn-success" id="grant-selected">Grant Selected</button>
                </div>
                <div class="table-responsive">
                    <table class="table" id="students-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="master-checkbox"></th>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Fee Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .badge {
        font-size: 1.0em;
        color: black;
    }
    .table th, .table td {
        vertical-align: middle;
    }
    .filter-loading::after {
        content: '';
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .error-alert {
        display: none;
        margin-bottom: 1rem;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    // Add error alert container
    $('.card').prepend('<div class="alert alert-danger error-alert" role="alert"></div>');

    // Function to show error alert
    function showError(message) {
        $('.error-alert').text(message).show();
        setTimeout(() => $('.error-alert').hide(), 5000);
    }

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Function to fetch students
    function fetchStudents() {
        const filters = {
            class_filter: $('#class_filter').val(),
            name_filter: $('#name_filter').val(),
            session_filter: $('#session_filter').val(),
            term_filter: $('#term_filter').val(),
            unpaid_fees: $('#unpaid_fees').val()
        };

        $('#students-table').addClass('filter-loading');
        $.ajax({
            url: '{% url "admin_manage_general_result_access" %}',
            type: 'GET',
            data: filters,
            dataType: 'json',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(response) {
                $('.error-alert').hide();
                const tbody = $('#students-table tbody');
                tbody.empty();
                if (response.students && Array.isArray(response.students) && response.students.length > 0) {
                    response.students.forEach(function(student) {
                        tbody.append(`
                            <tr>
                                <td><input type="checkbox" class="student-checkbox" value="${student.id}"></td>
                                <td>${student.full_name || 'N/A'}</td>
                                <td>${student.class_level || 'N/A'}</td>
                                <td>${student.fee_status || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-success grant-access-btn" data-student-id="${student.id}">Grant</button>
                                </td>
                            </tr>
                        `);
                    });
                } else {
                    tbody.append('<tr><td colspan="5" class="text-center">No students found.</td></tr>');
                }
                $('#students-table').removeClass('filter-loading');
            },
            error: function(xhr) {
                $('#students-table').removeClass('filter-loading');
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to fetch students';
                showError(`Error fetching students: ${errorMsg}`);
            }
        });
    }

    // Event listeners for filters
    $('#class_filter, #session_filter, #term_filter, #unpaid_fees').on('change', fetchStudents);
    $('#name_filter').on('input', debounce(fetchStudents, 300));

    // Select All / Unselect All
    $('#select-all').click(function() {
        $('.student-checkbox').prop('checked', true);
    });

    $('#unselect-all').click(function() {
        $('.student-checkbox').prop('checked', false);
    });

    $('#master-checkbox').click(function() {
        $('.student-checkbox').prop('checked', $(this).prop('checked'));
    });

    // Handle individual grant
    $('#students-table').on('click', '.grant-access-btn', function() {
        const button = $(this);
        const studentId = button.data('student-id');
        const sessionId = $('#session_filter').val();
        const term = $('#term_filter').val();
        if (!sessionId || !term) {
            showError('Please select a session and term.');
            return;
        }

        button.prop('disabled', true).addClass('filter-loading');
        $.ajax({
            url: '{% url "bulk_manage_result_access" %}',
            type: 'POST',
            data: {
                action: 'grant',
                is_general: true,
                student_ids: [studentId],
                session_id: sessionId,
                term: term,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                button.prop('disabled', false).removeClass('filter-loading');
                $('.error-alert').hide();
                if (response.status === 'success') {
                    fetchStudents(); // Refresh table
                } else {
                    showError(`Error: ${response.error || 'Unknown error'}`);
                }
            },
            error: function(xhr) {
                button.prop('disabled', false).removeClass('filter-loading');
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to perform action';
                showError(`Error performing action: ${errorMsg}`);
            }
        });
    });

    // Handle bulk grant
    $('#grant-selected').click(function() {
        const studentIds = $('.student-checkbox:checked').map(function() { return $(this).val(); }).get();
        const sessionId = $('#session_filter').val();
        const term = $('#term_filter').val();
        if (!sessionId || !term) {
            showError('Please select a session and term.');
            return;
        }
        if (studentIds.length === 0) {
            showError('No students selected.');
            return;
        }

        $(this).prop('disabled', true).addClass('filter-loading');
        $.ajax({
            url: '{% url "bulk_manage_result_access" %}',
            type: 'POST',
            data: {
                action: 'grant',
                is_general: true,
                student_ids: studentIds,
                session_id: sessionId,
                term: term,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                $(this).prop('disabled', false).removeClass('filter-loading');
                $('.error-alert').hide();
                if (response.status === 'success') {
                    fetchStudents(); // Refresh table
                } else {
                    showError(`Error: ${response.error || 'Unknown error'}`);
                }
            },
            error: function(xhr) {
                $(this).prop('disabled', false).removeClass('filter-loading');
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to perform action';
                showError(`Error performing action: ${errorMsg}`);
            }
        });
    });

    // Initial fetch
    fetchStudents();
});
</script>
{% endblock %}