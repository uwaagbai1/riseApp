{% extends 'account/base_generic.html' %}
{% load static %}
{% block content %}
<div class="hp-main-layout-content">
    <div class="row mb-32 gy-32">
        <div class="col-12">
            <div class="hp-bg-black-bg py-32 py-sm-64 px-24 px-sm-48 px-md-80 position-relative overflow-hidden hp-page-content" style="border-radius: 32px;">
                <div class="row">
                    <div class="col-12">
                        <h1 class="mb-0 hp-text-color-black-0">View Student Results</h1>
                        <h4 class="mt-8 hp-text-color-black-0">Results for Assigned Class Sections</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="row g-32">
                <div class="col-12">
                    <div class="card hp-bg-color-dark-90 p-24">
                        <!-- Filters -->
                        <form method="GET" class="mb-24">
                            <div class="row g-16">
                                <div class="col-md-4">
                                    <label for="session" class="form-label">Session</label>
                                    <select name="session" id="session" class="form-select">
                                        <option value="">Select Session</option>
                                        {% for session in sessions %}
                                            <option value="{{ session.id }}" {% if selected_session == session.id %}selected{% endif %}>{{ session.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="term" class="form-label">Term</label>
                                    <select name="term" id="term" class="form-select">
                                        <option value="">Select Term</option>
                                        {% for term_value, term_name in terms %}
                                            <option value="{{ term_value }}" {% if selected_term == term_value %}selected{% endif %}>{{ term_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4 align-self-end">
                                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                                </div>
                            </div>
                        </form>

                        {% if sections_results %}
                            {% for section_data in sections_results %}
                                <div class="mb-24">
                                    <h3>{{ section_data.section }} - {{ selected_session|default:'N/A' }} Term {{ selected_term|default:'N/A' }}</h3>
                                    <p>Total Students: {{ section_data.total_students }}</p>
                                </div>

                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                    <table class="table table-striped table-bordered" style="position: relative;">
                                        <thead style="position: sticky; top: 0; background: #343a40; z-index: 1;">
                                            <tr>
                                                <th>Student</th>
                                                {% for subject in section_data.subjects %}
                                                    <th>{{ subject.name }}</th>
                                                {% endfor %}
                                                <th>Average Score</th>
                                                {% if not section_data.is_nursery and not section_data.is_primary %}
                                                    <th>Average G.P</th>
                                                {% endif %}
                                                <th>Class Position</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in section_data.results_by_student %}
                                                <tr>
                                                    <td>{{ item.student.full_name }} ({{ item.student.admission_number }})</td>
                                                    {% for subject in section_data.subjects %}
                                                        {% with result=item.results|filter:"subject__id:"|add:subject.id %}
                                                            <td>
                                                                {% if result and result.term_average > 0 %}
                                                                    {{ result.term_average|floatformat:1 }} ({{ result.grade }})
                                                                {% else %}
                                                                    <span class="badge bg-secondary">Awaiting Input</span>
                                                                {% endif %}
                                                            </td>
                                                        {% endwith %}
                                                    {% endfor %}
                                                    <td>{{ item.average_score|floatformat:2 }}</td>
                                                    {% if not section_data.is_nursery and not section_data.is_primary %}
                                                        <td>{{ item.average_grade_point|floatformat:2|default:"-" }}</td>
                                                    {% endif %}
                                                    <td>{{ item.class_position }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>Select a session and term to view results for your assigned sections.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .table-responsive::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .table th, .table td {
            vertical-align: middle;
            border: 1px solid #444;
        }
        .form-select, .form-label {
            font-size: 0.9rem;
        }
    </style>


{% endblock content %}